<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
/* ── Reset & base ── */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, 'SF Pro Text', 'Helvetica Neue', 'Segoe UI', Roboto, sans-serif;
    font-size: 13px;
    color: #1A1A1A;
    line-height: 1.6;
    margin: 0;
    padding: 0;
    background-color: #FFFFFF;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

body.preinit .messages-container {
    visibility: hidden;
}

body.preinit .message {
    transition: none !important;
}

/* ── Session header ── */
.session-header {
    background-color: #FAFAFA;
    padding: 16px 20px;
    border-bottom: 1px solid #E0E0E0;
}

.session-title {
    font-weight: 600;
    font-size: 15px;
    color: #1A1A1A;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 6px;
}

.session-meta {
    font-size: 12px;
    color: #999;
    margin-bottom: 10px;
}

.session-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.stat-badge {
    font-size: 11px;
    color: #777;
    background-color: #FFF;
    border: 1px solid #E8E8E8;
    border-radius: 12px;
    padding: 4px 12px;
    white-space: nowrap;
}

/* ── Sticky toolbar (search + filters) ── */
.toolbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: #FAFAFA;
    border-bottom: 1px solid #E0E0E0;
    padding: 10px 20px;
}

.search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    font-size: 13px;
    font-family: inherit;
    color: #1A1A1A;
    background-color: #FFF;
    outline: none;
    transition: border-color 0.15s ease;
    margin-bottom: 8px;
}

.search-input:focus {
    border-color: #E67E22;
}

.search-input::placeholder {
    color: #BBB;
}

.filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.filter-chip {
    display: inline-block;
    padding: 5px 14px;
    border-radius: 14px;
    font-size: 12px;
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    border: none;
    color: white;
    transition: opacity 0.15s ease, background-color 0.15s ease;
    user-select: none;
}

.filter-chip:hover {
    opacity: 0.9;
}

.filter-chip.inactive {
    background-color: transparent !important;
    color: #999;
    border: 1px solid #E0E0E0;
}

.filter-chip.inactive:hover {
    background-color: #F0F0F0 !important;
    color: #555;
    opacity: 1;
}

.toolbar-footer {
    margin-top: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.pagination-controls {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.page-btn {
    border: 1px solid #D9DDE1;
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 11px;
    color: #4F5961;
    background-color: #FFFFFF;
    cursor: pointer;
}

.page-btn:hover {
    background-color: #F5F7F9;
}

.page-btn:disabled {
    opacity: 0.45;
    cursor: default;
}

.page-status {
    font-size: 11px;
    color: #8A949B;
}

.pagination-footer {
    margin: 4px 0 14px 0;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

/* ── Messages container ── */
.messages-container {
    padding: 12px 16px;
}

/* ── Message cards ── */
.message {
    border-radius: 8px;
    padding: 14px 16px;
    margin: 10px 0;
    transition: opacity 0.3s ease, max-height 0.4s ease, margin 0.3s ease, padding 0.3s ease;
    overflow: hidden;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.message.user {
    background-color: #FFF8F0;
    border: 1px solid #F0E6D6;
    border-left: 3px solid #E67E22;
}

.message.assistant {
    background-color: #FFFFFF;
    border: 1px solid #E8F5E9;
    border-left: 3px solid #27AE60;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

.message.tool-call-only {
    background-color: #FAFAFA;
    border: 1px solid #EAEAEA;
    border-left: 3px solid #8E44AD;
    padding: 8px 12px;
}

.message.system {
    background-color: #FFF8E1;
    border: 1px solid #F5E6C8;
    border-left: 3px solid #F39C12;
}

.message.tool-result {
    background-color: #FAFAFA;
    border: 1px solid #EAEAEA;
    border-left: 3px solid #999;
    padding: 8px 12px;
}

.message.hidden {
    opacity: 0;
    max-height: 0 !important;
    margin: 0;
    padding: 0 16px;
    border-width: 0;
    overflow: hidden;
}

.message.search-hidden {
    display: none;
}

.message.page-hidden {
    display: none;
}

.message.focus-target {
    box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.35), 0 8px 24px rgba(0, 0, 0, 0.08);
}

/* ── Message header ── */
.msg-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    padding-bottom: 6px;
    flex-wrap: wrap;
}

.message.user .msg-header {
    border-bottom: 1px solid #F0E6D6;
}

.message.assistant .msg-header {
    border-bottom: 1px solid #E8F5E9;
}

.message.system .msg-header {
    border-bottom: 1px solid #F5E6C8;
}

.role-badge {
    font-weight: 600;
    font-size: 13px;
}

.role-badge.user { color: #E67E22; }
.role-badge.assistant { color: #27AE60; }
.role-badge.system { color: #F39C12; }

.model-badge {
    font-size: 10px;
    color: #999;
    border: 1px solid #E0E0E0;
    border-radius: 3px;
    padding: 1px 6px;
}

.timestamp {
    font-size: 11px;
    color: #999;
    margin-left: 4px;
}

.token-badge {
    font-size: 10px;
    color: #999;
    font-family: 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
    margin-left: 4px;
}

/* ── Message content ── */
.message p, .message li, .message td, .message th {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.message img {
    max-width: 100%;
    height: auto;
}

/* ── Collapsible sections ── */
.collapsible {
    margin: 6px 0;
    border-radius: 6px;
    overflow: hidden;
}

.collapsible-header {
    cursor: pointer;
    padding: 7px 12px;
    border-radius: 6px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
    transition: background-color 0.15s ease;
}

.collapsible-header:hover {
    filter: brightness(0.97);
}

.collapsible-header .chevron {
    display: inline-block;
    transition: transform 0.25s ease;
    font-size: 10px;
    color: #999;
}

.collapsible.expanded .collapsible-header .chevron {
    transform: rotate(90deg);
}

.collapsible-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease;
}

.collapsible-body-inner {
    padding: 10px 12px;
    border: 1px solid transparent;
    border-top: none;
    border-radius: 0 0 6px 6px;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Thinking variant */
.collapsible.thinking .collapsible-header {
    background-color: #F8F6FC;
    border: 1px solid #E8E2F0;
    color: #9B8DB8;
}

.collapsible.thinking .collapsible-header b {
    color: #7B6B98;
}

.collapsible.thinking .collapsible-body-inner {
    font-size: 12px;
    color: #8A7FA0;
    background-color: #FDFCFE;
    border-color: #E8E2F0;
    line-height: 1.6;
}

/* Tool call variant */
.collapsible.tool-call .collapsible-header {
    background-color: #F8F8FA;
    border: 1px solid #E8E8EC;
    color: #999;
}

.collapsible.tool-call .collapsible-header b {
    color: #666;
}

.collapsible.tool-call .collapsible-body-inner {
    background-color: #FDFDFD;
    border-color: #E8E8EC;
    overflow-x: auto;
}

/* Tool result variant */
.collapsible.tool-result .collapsible-header {
    background-color: #FAFAFA;
    border: 1px solid #E0E0E0;
    color: #999;
}

.collapsible.tool-result .collapsible-body-inner {
    padding: 8px;
    font-family: 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
    font-size: 11px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    border-color: #E0E0E0;
}

/* ── Typography ── */
code {
    font-family: 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
    font-size: 12px;
    background-color: #F5F5F5;
    padding: 2px 5px;
    border-radius: 3px;
    border: 1px solid #EAEAEA;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

pre {
    background-color: #F8F8F8;
    padding: 12px 14px;
    border-radius: 6px;
    border: 1px solid #EAEAEA;
    overflow-x: auto;
    font-family: 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
    font-size: 12px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
}

pre code {
    background-color: transparent;
    padding: 0;
    border: none;
    white-space: pre-wrap;
}

a { color: #E67E22; text-decoration: none; }
a:hover { text-decoration: underline; }

table { border-collapse: collapse; margin: 8px 0; width: 100%; table-layout: fixed; }
th, td { border: 1px solid #E0E0E0; padding: 6px 10px; word-wrap: break-word; overflow-wrap: break-word; }
th { background-color: #FAFAFA; font-weight: 600; }

/* ── Code container with copy button ── */
.code-container {
    position: relative;
}

.code-container .copy-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background-color: rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 4px;
    padding: 3px 8px;
    font-size: 11px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    color: #666;
    font-family: -apple-system, sans-serif;
}

.code-container:hover .copy-btn {
    opacity: 1;
}

.copy-btn:hover {
    background-color: rgba(0,0,0,0.1);
}

/* ── Bash command styling ── */
.bash-command {
    background-color: #1A1A1A;
    color: #E0E0E0;
    padding: 10px 14px;
    border-radius: 6px;
    font-family: 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-all;
    border-left: 3px solid #27AE60;
}

.bash-command .prompt {
    color: #27AE60;
}

/* ── Search highlight ── */
mark.search-hl {
    background-color: #FFEE58;
    color: inherit;
    padding: 1px 2px;
    border-radius: 2px;
}

/* ── Empty state ── */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
    font-size: 14px;
}

/* ── Scrollbar ── */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: transparent;
}

::-webkit-scrollbar-thumb {
    background: #D0D0D0;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #B0B0B0;
}
</style>
</head>
<body class="preinit">

{session_header}

<div class="toolbar">
    <input class="search-input" type="text" placeholder="Search messages..." oninput="onSearchInput(this.value)">
    <div class="filter-chips">
        {filter_chips}
    </div>
    <div class="toolbar-footer">
        <div class="pagination-controls">
            <button id="page-prev" class="page-btn" onclick="goToPrevPage()">Previous</button>
            <button id="page-next" class="page-btn" onclick="goToNextPage()">Next</button>
        </div>
        <span id="page-status" class="page-status"></span>
    </div>
</div>

<div class="messages-container">
    {message_body}
</div>

<div class="pagination-footer">
    <div class="pagination-controls">
        <button id="page-prev-bottom" class="page-btn" onclick="goToPrevPage()">Previous</button>
        <button id="page-next-bottom" class="page-btn" onclick="goToNextPage()">Next</button>
    </div>
    <span id="page-status-bottom" class="page-status"></span>
</div>

<script>
/* ── Filter state ── */
var _activeFilters = {initial_filters};
var _FILTERS_STORAGE_KEY = 'cch_active_filters';
var _WINDOW_STATE_KEY = 'cch_state_v1';

function _allFilterNames() {
    var chips = document.querySelectorAll('.filter-chip[data-filter]');
    var names = [];
    for (var i = 0; i < chips.length; i++) {
        names.push(chips[i].getAttribute('data-filter'));
    }
    return names;
}

function _persistFilters() {
    var allNames = _allFilterNames();
    var allSet = {};
    for (var i = 0; i < allNames.length; i++) {
        allSet[allNames[i]] = true;
    }
    var sanitized = [];
    for (var i = 0; i < _activeFilters.length; i++) {
        var filterName = _activeFilters[i];
        if (typeof filterName === 'string' && allSet[filterName]) {
            sanitized.push(filterName);
        }
    }
    _activeFilters = sanitized;

    try {
        var state = {};
        if (window.name) {
            state = JSON.parse(window.name);
        }
        if (!state || typeof state !== 'object') {
            state = {};
        }
        state[_WINDOW_STATE_KEY] = { active_filters: sanitized };
        window.name = JSON.stringify(state);
    } catch (_e) {}

    try {
        sessionStorage.setItem(_FILTERS_STORAGE_KEY, JSON.stringify(sanitized));
    } catch (_e) {}
}

function _restorePersistedFilters() {
    var allowed = _allFilterNames();
    var allowedSet = {};
    for (var i = 0; i < allowed.length; i++) {
        allowedSet[allowed[i]] = true;
    }
    function _sanitize(listLike) {
        if (!Array.isArray(listLike)) return null;
        var restored = [];
        for (var i = 0; i < listLike.length; i++) {
            var f = listLike[i];
            if (typeof f === 'string' && allowedSet[f]) {
                restored.push(f);
            }
        }
        return restored;
    }

    try {
        if (window.name) {
            var state = JSON.parse(window.name);
            if (state && typeof state === 'object') {
                var payload = state[_WINDOW_STATE_KEY];
                if (payload && typeof payload === 'object') {
                    var fromWindowName = _sanitize(payload.active_filters);
                    if (fromWindowName !== null) {
                        _activeFilters = fromWindowName;
                        return;
                    }
                }
            }
        }
    } catch (_e) {}

    try {
        var raw = sessionStorage.getItem(_FILTERS_STORAGE_KEY);
        if (!raw) return;
        var parsed = JSON.parse(raw);
        var fromSessionStorage = _sanitize(parsed);
        if (fromSessionStorage !== null) {
            _activeFilters = fromSessionStorage;
        }
    } catch (_e) {}
}

function syncFilterChips() {
    var chips = document.querySelectorAll('.filter-chip');
    for (var i = 0; i < chips.length; i++) {
        var chip = chips[i];
        var filterName = chip.getAttribute('data-filter');
        if (_activeFilters.indexOf(filterName) !== -1) {
            chip.classList.remove('inactive');
        } else {
            chip.classList.add('inactive');
        }
    }
}

var _PAGE_SIZE = 100;
var _currentPage = 0;
var _visibleMessages = [];
var _searchQuery = "";

function toggleFilter(name) {
    var idx = _activeFilters.indexOf(name);
    if (idx !== -1) {
        _activeFilters.splice(idx, 1);
    } else {
        _activeFilters.push(name);
    }
    syncFilterChips();
    _persistFilters();
    applyFilters(true);
}

function applyFilters(resetPage) {
    _searchToken += 1;
    _applySearchAndFilters(resetPage !== false, _searchToken);
}

function _applySearchAndFilters(resetPage, token) {
    if (token !== _searchToken) return;
    clearTimeout(_highlightTimer);
    _clearHighlights();

    var input = document.querySelector('.search-input');
    var rawQuery = input ? input.value : "";
    _searchQuery = (rawQuery || "").trim().toLowerCase();

    var messages = document.querySelectorAll('.message[data-categories]');
    var matched = [];
    for (var i = 0; i < messages.length; i++) {
        var msg = messages[i];
        var filterMatch = _matchesFilters(msg);
        msg.classList.toggle('hidden', !filterMatch);

        var searchMatch = false;
        if (filterMatch) {
            if (!_searchQuery) {
                searchMatch = true;
            } else {
                searchMatch = _messageSearchText(msg).indexOf(_searchQuery) !== -1;
            }
        }

        msg.classList.toggle('search-hidden', !searchMatch);
        if (searchMatch) {
            matched.push(msg);
        }
    }

    _visibleMessages = matched;
    if (resetPage) {
        _currentPage = 0;
    }
    _renderPage(token);
}

function _matchesFilters(msg) {
    var cats = msg.getAttribute('data-categories');
    if (!cats) return false;
    var parts = cats.split(',');
    for (var i = 0; i < parts.length; i++) {
        if (_activeFilters.indexOf(parts[i]) !== -1) {
            return true;
        }
    }
    return false;
}

/* ── Search ── */
var _searchDebounce = null;
var _searchToken = 0;
var _highlightTimer = null;

function onSearchInput(query) {
    clearTimeout(_searchDebounce);
    _searchDebounce = setTimeout(function() {
        _searchToken += 1;
        _searchQuery = (query || "").trim().toLowerCase();
        _applySearchAndFilters(true, _searchToken);
    }, 260);
}

function _renderPage(token) {
    if (token !== _searchToken) return;

    clearTimeout(_highlightTimer);
    _clearHighlights();

    var total = _visibleMessages.length;
    var totalPages = Math.max(1, Math.ceil(total / _PAGE_SIZE));
    if (_currentPage >= totalPages) {
        _currentPage = totalPages - 1;
    }

    var start = _currentPage * _PAGE_SIZE;
    var end = Math.min(start + _PAGE_SIZE, total);
    var pageMatches = [];
    for (var i = 0; i < _visibleMessages.length; i++) {
        var msg = _visibleMessages[i];
        var inPage = i >= start && i < end;
        msg.classList.toggle('page-hidden', !inPage);
        if (inPage) {
            pageMatches.push(msg);
        }
    }

    _updatePaginationUi(total, totalPages, start, end);
    if (_searchQuery && pageMatches.length) {
        _scheduleHighlights(pageMatches, _searchQuery, token);
    }
}

function _updatePaginationUi(total, totalPages, start, end) {
    var prev = document.getElementById('page-prev');
    var next = document.getElementById('page-next');
    var status = document.getElementById('page-status');
    var prevBottom = document.getElementById('page-prev-bottom');
    var nextBottom = document.getElementById('page-next-bottom');
    var statusBottom = document.getElementById('page-status-bottom');
    if (!prev || !next || !status || !prevBottom || !nextBottom || !statusBottom) return;

    var atStart = _currentPage <= 0;
    var atEnd = _currentPage + 1 >= totalPages;
    prev.disabled = atStart;
    next.disabled = atEnd;
    prevBottom.disabled = atStart;
    nextBottom.disabled = atEnd;

    if (!total) {
        status.textContent = "No matching messages";
        statusBottom.textContent = "No matching messages";
        return;
    }

    var text =
        "Showing " + (start + 1) + "-" + end + " of " + total +
        " · Page " + (_currentPage + 1) + "/" + totalPages;
    status.textContent = text;
    statusBottom.textContent = text;
}

function goToPrevPage() {
    if (_currentPage <= 0) return;
    _currentPage -= 1;
    _searchToken += 1;
    _renderPage(_searchToken);
}

function goToNextPage() {
    var totalPages = Math.max(1, Math.ceil(_visibleMessages.length / _PAGE_SIZE));
    if (_currentPage + 1 >= totalPages) return;
    _currentPage += 1;
    _searchToken += 1;
    _renderPage(_searchToken);
}

function focusMessageByUuid(messageUuid) {
    if (!messageUuid) return false;

    var all = document.querySelectorAll('.message[data-message-uuid]');
    var target = null;
    for (var i = 0; i < all.length; i++) {
        if (all[i].getAttribute('data-message-uuid') === messageUuid) {
            target = all[i];
            break;
        }
    }
    if (!target) return false;

    var cats = target.getAttribute('data-categories');
    if (cats) {
        var parts = cats.split(',');
        for (var j = 0; j < parts.length; j++) {
            if (_activeFilters.indexOf(parts[j]) === -1) {
                _activeFilters.push(parts[j]);
            }
        }
        syncFilterChips();
        _persistFilters();
    }

    var searchInput = document.querySelector('.search-input');
    if (searchInput) {
        searchInput.value = '';
    }
    _searchQuery = "";
    _searchToken += 1;
    _applySearchAndFilters(false, _searchToken);

    var idx = -1;
    for (var k = 0; k < _visibleMessages.length; k++) {
        if (_visibleMessages[k].getAttribute('data-message-uuid') === messageUuid) {
            idx = k;
            break;
        }
    }
    if (idx >= 0) {
        _currentPage = Math.floor(idx / _PAGE_SIZE);
        _searchToken += 1;
        _renderPage(_searchToken);
    }

    requestAnimationFrame(function() {
        target.classList.add('focus-target');
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(function() {
            target.classList.remove('focus-target');
        }, 1800);
    });
    return true;
}

function _messageSearchText(msg) {
    var cached = msg.getAttribute('data-search-text');
    if (cached !== null) return cached;
    var text = (msg.textContent || '').toLowerCase();
    msg.setAttribute('data-search-text', text);
    return text;
}

function _clearHighlights() {
    var marks = document.querySelectorAll('mark.search-hl');
    for (var i = marks.length - 1; i >= 0; i--) {
        var m = marks[i];
        var parent = m.parentNode;
        if (!parent) continue;
        parent.replaceChild(document.createTextNode(m.textContent), m);
        parent.normalize();
    }
}

function _scheduleHighlights(matches, query, token) {
    if (!matches.length) return;
    var queryLen = query.length;
    var idx = 0;

    function runChunk() {
        if (token !== _searchToken) return;
        var deadline = Date.now() + 12;
        while (idx < matches.length && Date.now() < deadline) {
            _highlightIn(matches[idx], query, queryLen);
            idx += 1;
        }
        if (idx < matches.length) {
            _highlightTimer = setTimeout(runChunk, 0);
        }
    }

    _highlightTimer = setTimeout(runChunk, 0);
}

function _highlightIn(root, query, queryLen) {
    var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
    var qLower = query.toLowerCase();
    var nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);

    for (var i = 0; i < nodes.length; i++) {
        var node = nodes[i];
        if (!node.parentNode) continue;
        /* Skip nodes inside script, style, or already highlighted */
        var tag = node.parentNode.tagName;
        if (tag === 'SCRIPT' || tag === 'STYLE') continue;

        var text = node.nodeValue;
        var idx = text.toLowerCase().indexOf(qLower);
        if (idx === -1) continue;

        var frag = document.createDocumentFragment();
        var lastIdx = 0;
        while (idx !== -1) {
            if (idx > lastIdx) {
                frag.appendChild(document.createTextNode(text.substring(lastIdx, idx)));
            }
            var mark = document.createElement('mark');
            mark.className = 'search-hl';
            mark.textContent = text.substring(idx, idx + queryLen);
            frag.appendChild(mark);
            lastIdx = idx + queryLen;
            idx = text.toLowerCase().indexOf(qLower, lastIdx);
        }
        if (lastIdx < text.length) {
            frag.appendChild(document.createTextNode(text.substring(lastIdx)));
        }
        node.parentNode.replaceChild(frag, node);
    }
}

/* ── Collapsible ── */
function toggleCollapsible(id) {
    var el = document.getElementById(id);
    if (!el) return;
    var body = el.querySelector('.collapsible-body');
    if (!body) return;

    if (el.classList.contains('expanded')) {
        body.style.maxHeight = body.scrollHeight + 'px';
        body.offsetHeight; /* force reflow */
        body.style.maxHeight = '0px';
        el.classList.remove('expanded');
    } else {
        el.classList.add('expanded');
        body.style.maxHeight = body.scrollHeight + 'px';
        body.addEventListener('transitionend', function handler() {
            if (el.classList.contains('expanded')) {
                body.style.maxHeight = 'none';
            }
            body.removeEventListener('transitionend', handler);
        });
    }
}

/* ── Copy code ── */
function copyCode(btn) {
    var container = btn.parentElement;
    var codeEl = container.querySelector('code') || container.querySelector('pre');
    if (!codeEl) return;
    var text = codeEl.innerText || codeEl.textContent;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
    } else {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    }
    var orig = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.textContent = orig; }, 1500);
}

/* ── Scroll helpers ── */
function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function scrollToBottom() {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

/* ── Initial render state ── */
_restorePersistedFilters();
syncFilterChips();
applyFilters(true);
_persistFilters();
requestAnimationFrame(function() {
    document.body.classList.remove('preinit');
});
</script>
</body>
</html>
